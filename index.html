<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 美食外送</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://aistudiocdn.com/@google/genai@^1.20.0",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.1.1/client",
        "react": "https://aistudiocdn.com/react@^19.1.1",
        "react/": "https://aistudiocdn.com/react@^19.1.1/",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/"
      }
    }
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, Type } from "@google/genai";

      // 视图枚举
      const View = {
        RESTAURANTS: 'restaurants',
        MENU: 'menu',
        CART: 'cart',
        CHECKOUT: 'checkout',
        CONFIRMATION: 'confirmation',
      };

      // 常量
      const SHIPPING_FEE = 30;
      
      // --- 重要：請在這裡貼上您的 API 金鑰 ---
      // 警告：此金鑰將在前端程式碼中可見。僅供個人展示或開發使用。
      const API_KEY = "API_KEY=gen-lang-client-0800331839"; 

      // Gemini AI服务
      const ai = new GoogleGenAI({ apiKey: API_KEY });

      // 生成餐厅数据
      const generateRestaurantData = async () => {
        if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
            console.error("API 金鑰未設定。請在程式碼中設定 API_KEY。");
            // 備用資料
            return [
                { id: '1', name: "熾熱鐵板燒", category: "現代美式料理", rating: 4.7, reviews: 345, deliveryTime: "25-35 分鐘", minOrder: 150, image: "https://picsum.photos/500/300?random=1" },
                { id: '2', name: "京都花開壽司", category: "日式料理 & 壽司", rating: 4.9, reviews: 512, deliveryTime: "30-40 分鐘", minOrder: 200, image: "https://picsum.photos/500/300?random=2" },
                { id: '3', name: "義大利麵萬歲", category: "義式料理 & 披薩", rating: 4.6, reviews: 420, deliveryTime: "20-30 分鐘", minOrder: 120, image: "https://picsum.photos/500/300?random=3" },
            ];
        }
        try {
          const response = await ai.models.generateContent({
            model: "gemini-2.5-flash",
            contents: "請為一個美食外送 App 生成一個包含8家多樣化且吸引人的虛構餐廳列表。請以繁體中文提供詳細資訊，例如：名稱、類別、評分(介於3.5到5.0之間)、評論數、外送時間預估、最低訂單金額，以及一個來自 picsum.photos 的佔位圖片 URL。",
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  restaurants: {
                    type: Type.ARRAY,
                    items: {
                      type: Type.OBJECT,
                      properties: {
                        id: { type: Type.STRING, description: "餐廳的唯一識別碼。" },
                        name: { type: Type.STRING },
                        category: { type: Type.STRING },
                        rating: { type: Type.NUMBER },
                        reviews: { type: Type.INTEGER },
                        deliveryTime: { type: Type.STRING },
                        minOrder: { type: Type.INTEGER },
                        image: { type: Type.STRING, description: "一個來自 picsum.photos 的 URL，例如：https://picsum.photos/500/300" },
                      },
                      required: ["id", "name", "category", "rating", "reviews", "deliveryTime", "minOrder", "image"],
                    },
                  },
                },
              },
            },
          });
          
          const json = JSON.parse(response.text.trim());
          return json.restaurants;

        } catch (error) {
          console.error("生成餐廳資料時發生錯誤:", error);
          // 備用資料
          return [
              { id: '1', name: "熾熱鐵板燒", category: "現代美式料理", rating: 4.7, reviews: 345, deliveryTime: "25-35 分鐘", minOrder: 150, image: "https://picsum.photos/500/300?random=1" },
              { id: '2', name: "京都花開壽司", category: "日式料理 & 壽司", rating: 4.9, reviews: 512, deliveryTime: "30-40 分鐘", minOrder: 200, image: "https://picsum.photos/500/300?random=2" },
              { id: '3', name: "義大利麵萬歲", category: "義式料理 & 披薩", rating: 4.6, reviews: 420, deliveryTime: "20-30 分鐘", minOrder: 120, image: "https://picsum.photos/500/300?random=3" },
              { id: '4', name: "塔可真好吃", category: "墨西哥料理 & 塔可", rating: 4.5, reviews: 288, deliveryTime: "15-25 分鐘", minOrder: 80, image: "https://picsum.photos/500/300?random=4" },
              { id: '5', name: "正宗川菜館", category: "中式料理", rating: 4.8, reviews: 389, deliveryTime: "30-40 分鐘", minOrder: 180, image: "https://picsum.photos/500/300?random=5" },
              { id: '6', name: "法式甜點屋", category: "甜點 & 蛋糕", rating: 4.9, reviews: 267, deliveryTime: "20-30 分鐘", minOrder: 100, image: "https://picsum.photos/500/300?random=6" },
              { id: '7', name: "泰式風味", category: "泰式料理", rating: 4.4, reviews: 312, deliveryTime: "25-35 分鐘", minOrder: 150, image: "https://picsum.photos/500/300?random=7" },
              { id: '8', name: "健康蔬食", category: "素食 & 健康餐", rating: 4.6, reviews: 198, deliveryTime: "15-25 分鐘", minOrder: 120, image: "https://picsum.photos/500/300?random=8" },
          ];
        }
      };

      // 生成餐廳菜單
      const generateMenuForRestaurant = async (restaurantName, restaurantCategory) => {
          try {
              const response = await ai.models.generateContent({
                  model: "gemini-2.5-flash",
                  contents: `請為名為 "${restaurantName}" 的餐廳生成一份包含6個品項的真實菜單。對於每個品項，請提供唯一的 ID、名稱和價格。每個品項都應包含餐廳名稱以供參考。請使用繁體中文回答。`,
                  config: {
                      responseMimeType: "application/json",
                      responseSchema: {
                          type: Type.OBJECT,
                          properties: {
                              menu: {
                                  type: Type.ARRAY,
                                  items: {
                                      type: Type.OBJECT,
                                      properties: {
                                          id: { type: Type.STRING },
                                          name: { type: Type.STRING },
                                          price: { type: Type.NUMBER },
                                          restaurantName: { type: Type.STRING, description: "此品項所屬的餐廳名稱。" }
                                      },
                                      required: ["id", "name", "price", "restaurantName"],
                                  },
                              },
                          },
                      },
                  },
              });
              const json = JSON.parse(response.text.trim());
              return json.menu;
          } catch (error) {
              console.error(`為 ${restaurantName} 生成菜單時發生錯誤:`, error);
              // 備用資料 - 根據餐廳類別提供不同的菜單
              const fallbackMenus = {
                "現代美式料理": [
                  { id: 'm1', name: "經典漢堡", price: 180, restaurantName },
                  { id: 'm2', name: "起司漢堡", price: 200, restaurantName },
                  { id: 'm3', name: "薯條", price: 80, restaurantName },
                  { id: 'm4', name: "奶昔", price: 120, restaurantName },
                  { id: 'm5', name: "洋蔥圈", price: 90, restaurantName },
                  { id: 'm6', name: "招牌沙拉", price: 150, restaurantName },
                ],
                "日式料理 & 壽司": [
                  { id: 'm1', name: "綜合壽司拼盤", price: 320, restaurantName },
                  { id: 'm2', name: "鮭魚生魚片", price: 280, restaurantName },
                  { id: 'm3', name: "天婦羅烏龍麵", price: 220, restaurantName },
                  { id: 'm4', "name": "照燒雞肉飯", price: 180, restaurantName },
                  { id: 'm5', name: "味噌湯", price: 60, restaurantName },
                  { id: 'm6', name: "日式煎餃", price: 120, restaurantName },
                ],
                "義式料理 & 披薩": [
                  { id: 'm1', name: "瑪格麗特披薩", price: 280, restaurantName },
                  { id: 'm2', name: "培根蛋奶義大利麵", price: 240, restaurantName },
                  { id: 'm3', name: "凱薩沙拉", price: 160, restaurantName },
                  { id: 'm4', name: "蒜香麵包", price: 80, restaurantName },
                  { id: 'm5', name: "提拉米蘇", price: 120, restaurantName },
                  { id: 'm6', name: "義式濃縮咖啡", price: 60, restaurantName },
                ],
                "墨西哥料理 & 塔可": [
                  { id: 'm1', name: "牛肉塔可", price: 120, restaurantName },
                  { id: 'm2', name: "雞肉捲餅", price: 160, restaurantName },
                  { id: 'm3', name: "酪梨醬", price: 80, restaurantName },
                  { id: 'm4', name: "墨西哥玉米片", price: 100, restaurantName },
                  { id: 'm5', name: "莎莎醬", price: 60, restaurantName },
                  { id: 'm6', name: "墨西哥汽水", price: 50, restaurantName },
                ]
              };
              
              const matchingCategory = Object.keys(fallbackMenus).find(cat => restaurantCategory?.includes(cat.split(' ')[0]));
              return fallbackMenus[matchingCategory] || fallbackMenus["現代美式料理"];
          }
      };

      // 處理訂單
      const processOrder = async (orderDetails, cart) => {
          try {
              const prompt = `一位顧客下了一張美食外送訂單。
              顧客資料: ${JSON.stringify(orderDetails)}。
              訂單品項: ${cart.map(item => `${item.name} x${item.quantity}`).join(', ')}。
              請根據這些資訊，生成一個唯一的訂單編號（格式：ORD-XXXXXX）和一個真實的預計送達時間（例如：25-35 分鐘）。`;

              const response = await ai.models.generateContent({
                  model: "gemini-2.5-flash",
                  contents: prompt,
                  config: {
                      responseMimeType: "application/json",
                      responseSchema: {
                          type: Type.OBJECT,
                          properties: {
                              orderNumber: { type: Type.STRING },
                              estimatedDeliveryTime: { type: Type.STRING },
                          },
                          required: ["orderNumber", "estimatedDeliveryTime"],
                      },
                  },
              });
              const json = JSON.parse(response.text.trim());
              return json;
          } catch (error) {
              console.error("處理訂單時發生錯誤:", error);
              // 備用資料
              return {
                  orderNumber: `ORD-${Math.floor(100000 + Math.random() * 900000)}`,
                  estimatedDeliveryTime: "20-30 分鐘",
              };
          }
      };

      // Google Sheets服務
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSbm2_MC7RFB8YBh7XEJX7X9-Qp1i6_wvd1lzayxpEP2dF-Z99oHkD__amudmkrg/exec';

      const saveOrder = async (orderData) => {
          try {
              const sheetData = {
                  orderNumber: orderData.orderNumber,
                  customerName: orderData.customerName,
                  customerPhone: orderData.customerPhone,
                  deliveryAddress: orderData.deliveryAddress,
                  paymentMethod: orderData.paymentMethod,
                  orderNotes: orderData.orderNotes,
                  items: orderData.items.map(item => `${item.name} x${item.quantity}`).join(', '),
                  subtotal: orderData.subtotal,
                  shippingFee: orderData.shippingFee,
                  total: orderData.total,
                  orderTime: new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })
              };
              
              const response = await fetch(`${SCRIPT_URL}?action=saveOrder`, {
                  method: 'POST',
                  redirect: 'follow',
                  headers: {
                      'Content-Type': 'text/plain;charset=utf-8',
                  },
                  body: JSON.stringify({ orderData: sheetData }),
              });

              if (!response.ok) {
                throw new Error(`Google Sheets API 回應錯誤，狀態碼: ${response.status}`);
              }

              const result = await response.json();

              if (!result.success) {
                  throw new Error(result.error || '無法將訂單儲存至 Google Sheets');
              }

              return { success: true, message: result.message };

          } catch (error) {
              console.error('儲存訂單至 Google Sheet 時發生錯誤:', error);
              if (error instanceof Error) {
                  return { success: false, message: error.message };
              }
              return { success: false, message: '儲存訂單時發生未知錯誤' };
          }
      };

      // 組件定義
      const Header = ({ cartItemCount, onCartClick, onLogoClick }) => {
        return (
          <header className="bg-gradient-to-r from-red-500 to-orange-400 text-white p-4 shadow-lg sticky top-0 z-50">
            <div className="container mx-auto flex justify-between items-center">
              <div className="text-2xl font-bold cursor-pointer" onClick={onLogoClick}>
                <i className="fas fa-utensils mr-2"></i> Gemini 美食外送
              </div>
              <button
                onClick={onCartClick}
                className="relative bg-white/20 hover:bg-white/30 transition-colors duration-300 px-4 py-2 rounded-full flex items-center space-x-2"
              >
                <i className="fas fa-shopping-cart"></i>
                <span>購物車</span>
                {cartItemCount > 0 && (
                  <span className="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">
                    {cartItemCount}
                  </span>
                )}
              </button>
            </div>
          </header>
        );
      };

      const Spinner = ({ message = "載入中..." }) => {
        return (
          <div className="flex flex-col items-center justify-center min-h-[60vh] text-gray-600">
            <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500 mb-4"></div>
            <p className="text-lg font-semibold">{message}</p>
          </div>
        );
      };

      const Alert = ({ message, type, onClose }) => {
        useEffect(() => {
          const timer = setTimeout(() => {
            onClose();
          }, 3000);

          return () => clearTimeout(timer);
        }, [onClose]);

        const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

        return (
          <div
            className={`fixed top-5 right-5 z-50 flex items-center text-white px-6 py-4 rounded-lg shadow-xl animate-slideIn ${bgColor}`}
          >
            <i className={`fas ${icon} mr-3 text-xl`}></i>
            <span>{message}</span>
            <button onClick={onClose} className="ml-4 text-white hover:text-gray-200">
              <i className="fas fa-times"></i>
            </button>
            <style>{`
              @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
              }
              .animate-slideIn {
                animation: slideIn 0.5s ease-out forwards;
              }
            `}</style>
          </div>
        );
      };

      const StarRating = ({ rating }) => {
          const fullStars = Math.floor(rating);
          const halfStar = rating % 1 >= 0.5;
          const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        
          return (
            <div className="flex items-center text-yellow-400">
              {[...Array(fullStars)].map((_, i) => <i key={`full-${i}`} className="fas fa-star"></i>)}
              {halfStar && <i className="fas fa-star-half-alt"></i>}
              {[...Array(emptyStars)].map((_, i) => <i key={`empty-${i}`} className="far fa-star"></i>)}
            </div>
          );
      };

      const RestaurantCard = ({ restaurant, onClick }) => {
        return (
          <div
            className="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer group"
            onClick={onClick}
          >
            <div className="relative">
              <img src={restaurant.image} alt={restaurant.name} className="w-full h-48 object-cover" />
              <div className="absolute inset-0 bg-black bg-opacity-20 group-hover:bg-opacity-10 transition-opacity duration-300"></div>
            </div>
            <div className="p-4">
              <h3 className="text-xl font-bold text-gray-800 mb-1">{restaurant.name}</h3>
              <p className="text-gray-500 text-sm mb-2">{restaurant.category}</p>
              <div className="flex items-center mb-3">
                <StarRating rating={restaurant.rating} />
                <span className="text-gray-600 text-sm ml-2">{restaurant.rating.toFixed(1)} (${restaurant.reviews} 則評論)</span>
              </div>
              <div className="flex justify-between items-center text-sm text-gray-700 border-t pt-3 mt-3">
                <div className="flex items-center">
                  <i className="fas fa-clock mr-2 text-gray-400"></i>
                  <span>{restaurant.deliveryTime}</span>
                </div>
                <div className="flex items-center">
                  <i className="fas fa-dollar-sign mr-1 text-gray-400"></i>
                  <span>低消 NT$${restaurant.minOrder}</span>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const RestaurantList = ({ restaurants, onSelectRestaurant }) => {
        return (
          <section className="py-8">
            <h2 className="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">選擇餐廳</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {restaurants.map(restaurant => (
                <RestaurantCard 
                  key={restaurant.id} 
                  restaurant={restaurant} 
                  onClick={() => onSelectRestaurant(restaurant)} 
                />
              ))}
            </div>
          </section>
        );
      };

      const MenuItemCard = ({ item, onAddToCart }) => (
          <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center hover:shadow-md transition-shadow duration-200">
              <div>
                  <h4 className="font-semibold text-gray-800">{item.name}</h4>
                  <p className="text-red-500 font-bold">NT$ {item.price}</p>
              </div>
              <button 
                  onClick={() => onAddToCart(item)}
                  className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 text-sm flex items-center"
              >
                  <i className="fas fa-plus mr-2"></i> 加入
              </button>
          </div>
      );

      const MenuView = ({ restaurant, menuItems, onAddToCart, onBack, isLoading }) => {
        return (
          <div className="bg-white rounded-lg p-6 shadow-lg my-8">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
              <div className="mb-4 md:mb-0">
                  <button onClick={onBack} className="text-gray-600 hover:text-red-500 mb-2 flex items-center">
                      <i className="fas fa-arrow-left mr-2"></i>返回餐廳列表
                  </button>
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-800">{restaurant.name} 菜單</h2>
                  <p className="text-gray-500 mt-1">{restaurant.category}</p>
              </div>
              <img src={restaurant.image} alt={restaurant.name} className="w-24 h-24 object-cover rounded-lg shadow-md" />
            </div>
            {isLoading ? (
              <Spinner message="正在載入菜單..." />
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {menuItems.map(item => (
                  <MenuItemCard key={item.id} item={item} onAddToCart={onAddToCart} />
                ))}
              </div>
            )}
          </div>
        );
      };

      const CartView = ({ cart, onUpdateQuantity, onRemoveItem, onCheckout, onBack }) => {
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const total = subtotal + SHIPPING_FEE;

        return (
          <div className="bg-white rounded-lg p-6 shadow-lg my-8">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
              <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">您的購物車</h2>
              <button onClick={onBack} className="text-gray-600 hover:text-red-500 flex items-center">
                <i className="fas fa-shopping-bag mr-2"></i>繼續購物
              </button>
            </div>
            {cart.length === 0 ? (
              <div className="text-center text-gray-500 py-12">
                <i className="fas fa-shopping-cart text-5xl mb-4 text-gray-300"></i>
                <p className="text-lg">您的購物車是空的。</p>
                <button onClick={onBack} className="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                  開始點餐
                </button>
              </div>
            ) : (
              <div>
                <div className="space-y-4 mb-6">
                  {cart.map(item => (
                    <div key={item.id} className="flex flex-col sm:flex-row items-center justify-between p-3 border rounded-lg">
                      <div className="flex-grow mb-2 sm:mb-0">
                        <p className="font-semibold">{item.name}</p>
                        <p className="text-sm text-gray-500">NT$ {item.price}</p>
                      </div>
                      <div className="flex items-center space-x-2 mb-2 sm:mb-0">
                        <button onClick={() => onUpdateQuantity(item.id, item.quantity - 1)} className="w-8 h-8 bg-gray-200 rounded-full font-bold hover:bg-gray-300">-</button>
                        <span className="w-10 text-center font-semibold">{item.quantity}</span>
                        <button onClick={() => onUpdateQuantity(item.id, item.quantity + 1)} className="w-8 h-8 bg-gray-200 rounded-full font-bold hover:bg-gray-300">+</button>
                      </div>
                      <div className="flex items-center">
                        <p className="w-24 text-right font-bold mr-4">NT$ {item.price * item.quantity}</p>
                        <button onClick={() => onRemoveItem(item.id)} className="text-red-500 hover:text-red-700">
                          <i className="fas fa-trash-alt"></i>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="border-t pt-4">
                  <div className="flex justify-between mb-2 text-gray-600">
                    <span>小計：</span>
                    <span>NT$ {subtotal}</span>
                  </div>
                  <div className="flex justify-between mb-2 text-gray-600">
                    <span>外送費：</span>
                    <span>NT$ {SHIPPING_FEE}</span>
                  </div>
                  <div className="flex justify-between font-bold text-xl mt-4 pt-4 border-t">
                    <span>總計：</span>
                    <span>NT$ {total}</span>
                  </div>
                  <button
                    onClick={onCheckout}
                    className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-6 transition-colors duration-300"
                  >
                    前往結帳
                  </button>
                </div>
              </div>
            )}
          </div>
        );
      };

      const CheckoutView = ({ onSubmit, onBack, isLoading }) => {
        const [details, setDetails] = useState({
          customerName: '',
          customerPhone: '',
          deliveryAddress: '',
          paymentMethod: '',
          orderNotes: '',
        });

        const handleChange = (e) => {
          const { name, value } = e.target;
          setDetails(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit(details);
        };

        return (
          <div className="bg-white rounded-lg p-6 shadow-lg my-8">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
              <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-0">結帳</h2>
              <button onClick={onBack} className="text-gray-600 hover:text-red-500 flex items-center">
                  <i className="fas fa-arrow-left mr-2"></i>返回購物車
              </button>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="form-group">
                      <label htmlFor="customerName" className="block text-sm font-medium text-gray-700">全名 *</label>
                      <input type="text" id="customerName" name="customerName" value={details.customerName} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
                  </div>
                  <div className="form-group">
                      <label htmlFor="customerPhone" className="block text-sm font-medium text-gray-700">電話號碼 *</label>
                      <input type="tel" id="customerPhone" name="customerPhone" value={details.customerPhone} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
                  </div>
              </div>
              <div className="form-group">
                  <label htmlFor="deliveryAddress" className="block text-sm font-medium text-gray-700">外送地址 *</label>
                  <input type="text" id="deliveryAddress" name="deliveryAddress" value={details.deliveryAddress} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="form-group">
                      <label htmlFor="paymentMethod" className="block text-sm font-medium text-gray-700">付款方式 *</label>
                      <select id="paymentMethod" name="paymentMethod" value={details.paymentMethod} onChange={handleChange} required className="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                          <option value="">請選擇付款方式</option>
                          <option value="貨到付款">貨到付款</option>
                          <option value="信用卡">信用卡</option>
                          <option value="LINE Pay">LINE Pay</option>
                      </select>
                  </div>
                  <div className="form-group">
                      <label htmlFor="orderNotes" className="block text-sm font-medium text-gray-700">訂單備註</label>
                      <input type="text" id="orderNotes" name="orderNotes" value={details.orderNotes || ''} onChange={handleChange} placeholder="例如：不要洋蔥" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" />
                  </div>
              </div>
              
              <button 
                type="submit" 
                disabled={isLoading}
                className={`w-full ${isLoading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'} text-white font-bold py-3 px-4 rounded-lg mt-6 transition-colors duration-300 flex justify-center items-center`}
              >
                {isLoading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mr-2"></div>
                    處理中...
                  </>
                ) : '提交訂單'}
              </button>
            </form>
          </div>
        );
      };

      const ConfirmationView = ({ order, onNewOrder }) => {
        return (
          <div className="bg-white rounded-lg p-8 shadow-lg my-8 text-center">
            <div className="text-6xl text-green-500 mb-4">
              <i className="fas fa-check-circle"></i>
            </div>
            <h2 className="text-3xl font-bold text-gray-800 mb-2">訂單提交成功！</h2>
            <p className="text-gray-600 mb-6">感謝您的訂購，美食正在路上！</p>
            
            <div className="text-left bg-gray-50 p-6 rounded-lg border w-full max-w-md mx-auto space-y-3">
              <p><strong>訂單編號：</strong> <span className="font-mono text-red-500">{order.orderNumber}</span></p>
              <p><strong>預計送達時間：</strong> <span className="font-semibold">{order.estimatedDeliveryTime}</span></p>
              <p><strong>顧客姓名：</strong> {order.customerName}</p>
              <p><strong>外送至：</strong> {order.deliveryAddress}</p>
              <p><strong>總金額：</strong> <span className="font-bold">NT$ {order.total}</span></p>
            </div>

            <button
              onClick={onNewOrder}
              className="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg mt-8 transition-colors duration-300"
            >
              建立新訂單
            </button>
          </div>
        );
      };

      // 主應用組件
      const App = () => {
        const [isBlocked, setIsBlocked] = useState(false);
        const [view, setView] = useState(View.RESTAURANTS);
        const [restaurants, setRestaurants] = useState([]);
        const [selectedRestaurant, setSelectedRestaurant] = useState(null);
        const [menuItems, setMenuItems] = useState([]);
        const [cart, setCart] = useState(() => {
          try {
            const savedCart = localStorage.getItem('foodDeliveryCart');
            return savedCart ? JSON.parse(savedCart) : [];
          } catch (error) {
            return [];
          }
        });
        const [confirmedOrder, setConfirmedOrder] = useState(null);
        const [isLoading, setIsLoading] = useState(true);
        const [isMenuLoading, setIsMenuLoading] = useState(false);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [alert, setAlert] = useState(null);

        useEffect(() => {
          if (window.location.protocol === 'file:') {
              setIsBlocked(true);
              setIsLoading(false);
              return;
          }

          const fetchRestaurants = async () => {
            setIsLoading(true);
            const data = await generateRestaurantData();
            setRestaurants(data);
            setIsLoading(false);
          };
          fetchRestaurants();
        }, []);

        useEffect(() => {
          localStorage.setItem('foodDeliveryCart', JSON.stringify(cart));
        }, [cart]);

        const showAlert = (message, type = 'success') => {
          setAlert({ message, type });
        };

        const handleSelectRestaurant = useCallback(async (restaurant) => {
          setSelectedRestaurant(restaurant);
          setView(View.MENU);
          setIsMenuLoading(true);
          const menuData = await generateMenuForRestaurant(restaurant.name, restaurant.category);
          setMenuItems(menuData);
          setIsMenuLoading(false);
        }, []);

        const handleAddToCart = (item) => {
          setCart(prevCart => {
            const existingItem = prevCart.find(cartItem => cartItem.id === item.id);
            if (existingItem) {
              return prevCart.map(cartItem =>
                cartItem.id === item.id ? { ...cartItem, quantity: cartItem.quantity + 1 } : cartItem
              );
            }
            return [...prevCart, { ...item, quantity: 1 }];
          });
          showAlert(`${item.name} 已加入購物車！`);
        };

        const handleUpdateQuantity = (itemId, newQuantity) => {
          if (newQuantity <= 0) {
            handleRemoveFromCart(itemId);
          } else {
            setCart(prevCart =>
              prevCart.map(item => (item.id === itemId ? { ...item, quantity: newQuantity } : item))
            );
          }
        };

        const handleRemoveFromCart = (itemId) => {
          const itemToRemove = cart.find(item => item.id === itemId);
          setCart(prevCart => prevCart.filter(item => item.id !== itemId));
          if (itemToRemove) {
              showAlert(`${itemToRemove.name} 已從購物車移除。`, 'error');
          }
        };

        const handleSubmitOrder = async (details) => {
          setIsSubmitting(true);
          try {
              const { orderNumber, estimatedDeliveryTime } = await processOrder(details, cart);

              const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
              const total = subtotal + SHIPPING_FEE;

              const newConfirmedOrder = {
                ...details,
                orderNumber,
                estimatedDeliveryTime,
                items: cart.map(({ name, quantity }) => ({ name, quantity })),
                subtotal,
                shippingFee: SHIPPING_FEE,
                total,
              };
              
              const saveResult = await saveOrder(newConfirmedOrder);

              if (!saveResult.success) {
                  throw new Error(saveResult.message || '無法將訂單儲存至後端系統。');
              }

              setConfirmedOrder(newConfirmedOrder);
              setCart([]);
              setView(View.CONFIRMATION);

          } catch (error) {
              console.error("提交訂單失敗:", error);
              const errorMessage = error instanceof Error ? error.message : '提交訂單時發生未知錯誤。';
              showAlert(errorMessage, 'error');
          } finally {
              setIsSubmitting(false);
          }
        };
        
        const handleNewOrder = () => {
          setConfirmedOrder(null);
          setSelectedRestaurant(null);
          setMenuItems([]);
          setView(View.RESTAURANTS);
        };

        const NoApiKeyView = () => (
            <div className="flex items-center justify-center min-h-[80vh] font-sans">
                <div className="text-center p-8 bg-white shadow-lg rounded-lg max-w-md mx-4">
                    <i className="fas fa-key text-5xl text-yellow-500 mb-4"></i>
                    <h1 className="text-2xl font-bold text-gray-800 mb-2">API 金鑰尚未設定</h1>
                    <p className="text-gray-600">
                        請在 <code>index.html</code> 檔案中找到 <code>API_KEY</code> 變數，並填入您的 Google Gemini API 金鑰以啟動應用程式。
                    </p>
                </div>
            </div>
        );

        if (isBlocked) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gray-100 font-sans">
                <div className="text-center p-8 bg-white shadow-lg rounded-lg max-w-md mx-4">
                  <i className="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">無法載入應用程式</h1>
                  <p className="text-gray-600">
                    此應用程式無法從本機檔案系統執行。請透過網頁伺服器存取以確保正常運作。
                  </p>
                </div>
              </div>
            );
        }

        const renderContent = () => {
          if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
              return <NoApiKeyView />;
          }
          if (isLoading && view === View.RESTAURANTS) return <Spinner message="正在載入餐廳..." />;

          switch (view) {
            case View.MENU:
              return selectedRestaurant && <MenuView 
                  restaurant={selectedRestaurant} 
                  menuItems={menuItems} 
                  onAddToCart={handleAddToCart}
                  onBack={() => setView(View.RESTAURANTS)}
                  isLoading={isMenuLoading}
              />;
            case View.CART:
              return <CartView 
                  cart={cart}
                  onUpdateQuantity={handleUpdateQuantity}
                  onRemoveItem={handleRemoveFromCart}
                  onCheckout={() => setView(View.CHECKOUT)}
                  onBack={() => selectedRestaurant ? setView(View.MENU) : setView(View.RESTAURANTS)}
              />;
            case View.CHECKOUT:
              return <CheckoutView onSubmit={handleSubmitOrder} onBack={() => setView(View.CART)} isLoading={isSubmitting} />;
            case View.CONFIRMATION:
              return confirmedOrder && <ConfirmationView order={confirmedOrder} onNewOrder={handleNewOrder} />;
            case View.RESTAURANTS:
            default:
              return <RestaurantList restaurants={restaurants} onSelectRestaurant={handleSelectRestaurant} />;
          }
        };

        const cartItemCount = cart.reduce((total, item) => total + item.quantity, 0);

        return (
          <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
            {alert && <Alert message={alert.message} type={alert.type} onClose={() => setAlert(null)} />}
            <Header cartItemCount={cartItemCount} onCartClick={() => setView(View.CART)} onLogoClick={() => setView(View.RESTAURANTS)} />
            <main className="container mx-auto px-4">
              {renderContent()}
            </main>
            <footer className="bg-gray-800 text-white text-center p-6 mt-12">
                  <p>© {new Date().getFullYear()} Gemini 美食外送. 版權所有.</p>
              </footer>
          </div>
        );
      };

      // 渲染應用
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);
    </script>
  </body>

</html>
